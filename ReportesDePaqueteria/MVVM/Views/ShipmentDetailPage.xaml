<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="ReportesDePaqueteria.MVVM.Views.ShipmentDetailPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             Title="Detalle de envío"
             BackgroundColor="#F5F6F8"
             Shell.NavBarIsVisible="False">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Paleta -->
            <Color x:Key="Primary">#FF8302</Color>
            <Color x:Key="PrimarySoft">#FFF0E0</Color>
            <Color x:Key="TextDark">#111827</Color>
            <Color x:Key="TextLight">#6B7280</Color>
            <Color x:Key="CardBg">#FFFFFF</Color>
            <Color x:Key="ChipBg">#E5E7EB</Color>

            <!-- Tipos -->
            <Style TargetType="Label" x:Key="H1">
                <Setter Property="FontSize" Value="22"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="TextColor" Value="White"/>
            </Style>
            <Style TargetType="Label" x:Key="H2">
                <Setter Property="FontSize" Value="18"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="TextColor" Value="{StaticResource TextDark}"/>
                <Setter Property="Margin" Value="0,10,0,6"/>
            </Style>
            <Style TargetType="Label" x:Key="MetaWhite">
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="TextColor" Value="#FFFFFFCC"/>
            </Style>

            <!-- Card / Chip / Botones -->
            <Style TargetType="Frame" x:Key="Card">
                <Setter Property="Padding" Value="16"/>
                <Setter Property="Margin" Value="0,10"/>
                <Setter Property="BackgroundColor" Value="{StaticResource CardBg}"/>
                <Setter Property="CornerRadius" Value="16"/>
                <Setter Property="HasShadow" Value="True"/>
            </Style>
            <Style TargetType="Frame" x:Key="Chip">
                <Setter Property="Padding" Value="8,4"/>
                <Setter Property="BackgroundColor" Value="{StaticResource ChipBg}"/>
                <Setter Property="CornerRadius" Value="16"/>
                <Setter Property="HasShadow" Value="False"/>
            </Style>
            <Style TargetType="Button" x:Key="PrimaryButton">
                <Setter Property="BackgroundColor" Value="{StaticResource Primary}"/>
                <Setter Property="TextColor" Value="White"/>
                <Setter Property="CornerRadius" Value="12"/>
                <Setter Property="Padding" Value="14,12"/>
            </Style>
            <Style TargetType="Button" x:Key="FlatButton">
                <Setter Property="BackgroundColor" Value="Transparent"/>
                <Setter Property="TextColor" Value="{StaticResource Primary}"/>
                <Setter Property="Padding" Value="10,8"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- OJO: Grid sí permite varios hijos; el problema estaba en los Frame -->
    <Grid RowDefinitions="Auto,*">

        <!-- Header -->
        <Grid Grid.Row="0" Padding="20,20,20,14">
            <Grid.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#FF9F3A" Offset="0"/>
                    <GradientStop Color="#FF8302" Offset="1"/>
                </LinearGradientBrush>
            </Grid.Background>

            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto" ColumnSpacing="10">
                <Label Grid.ColumnSpan="2"
                       Text="{Binding Tracking}"
                       Style="{StaticResource H1}" />

                <HorizontalStackLayout Grid.Row="1" Spacing="8">
                    <Frame Style="{StaticResource Chip}">
                        <Label Text="{Binding Estado}" FontSize="12"/>
                    </Frame>
                    <Frame Style="{StaticResource Chip}">
                        <Label Text="{Binding Servicio}" FontSize="12"/>
                    </Frame>
                </HorizontalStackLayout>

                <Grid Grid.Row="1" Grid.Column="1" HorizontalOptions="End">
                    <Label Text="{Binding FechaEnvio, StringFormat='Enviado: {0:dd/MM/yyyy}'}"
                           Style="{StaticResource MetaWhite}" HorizontalTextAlignment="End"/>
                    <Label Text="{Binding EstimadoEntrega, StringFormat='ETA: {0:dd/MM/yyyy}'}"
                           Style="{StaticResource MetaWhite}" HorizontalTextAlignment="End"/>
                </Grid>
            </Grid>
        </Grid>

        <!-- Contenido -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="16" Spacing="6">

                <!-- Ruta -->
                <Frame Style="{StaticResource Card}">
                    <VerticalStackLayout>
                        <Label Text="Ruta" Style="{StaticResource H2}"/>
                        <Grid ColumnDefinitions="*,Auto,*" ColumnSpacing="10">
                            <VerticalStackLayout Spacing="2">
                                <Label Text="Origen" FontAttributes="Bold"/>
                                <Label Text="{Binding Origen}" TextColor="{StaticResource TextLight}"/>
                            </VerticalStackLayout>

                            <Image Source="arrow-right.png" WidthRequest="28" HeightRequest="28"
                                   HorizontalOptions="Center" VerticalOptions="Center"/>

                            <VerticalStackLayout Grid.Column="2" Spacing="2">
                                <Label Text="Destino" FontAttributes="Bold"/>
                                <Label Text="{Binding Destino}" TextColor="{StaticResource TextLight}"/>
                            </VerticalStackLayout>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- Remitente / Destinatario -->
                <Frame Style="{StaticResource Card}">
                    <VerticalStackLayout>
                        <Label Text="Remitente y Destinatario" Style="{StaticResource H2}"/>
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                            <VerticalStackLayout Spacing="2">
                                <Label Text="Remitente" FontAttributes="Bold"/>
                                <Label Text="{Binding Remitente}" />
                                <Label Text="{Binding RemitenteContacto}" TextColor="{StaticResource TextLight}" FontSize="12"/>
                            </VerticalStackLayout>
                            <VerticalStackLayout Grid.Column="1" Spacing="2">
                                <Label Text="Destinatario" FontAttributes="Bold"/>
                                <Label Text="{Binding Destinatario}" />
                                <Label Text="{Binding DestinatarioContacto}" TextColor="{StaticResource TextLight}" FontSize="12"/>
                            </VerticalStackLayout>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- Paquete -->
                <Frame Style="{StaticResource Card}">
                    <VerticalStackLayout>
                        <Label Text="Paquete" Style="{StaticResource H2}"/>
                        <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="14" RowSpacing="6">
                            <Label Text="Peso" TextColor="{StaticResource TextLight}"/>
                            <Label Grid.Column="1" Text="{Binding Peso}" />
                            <Label Grid.Row="1" Text="Dimensiones" TextColor="{StaticResource TextLight}"/>
                            <Label Grid.Row="1" Grid.Column="1" Text="{Binding Dimensiones}" />
                            <Label Grid.Row="2" Text="Contenido" TextColor="{StaticResource TextLight}"/>
                            <Label Grid.Row="2" Grid.Column="1" Text="{Binding Contenido}" />
                        </Grid>
                        <Grid ColumnDefinitions="*,Auto" Margin="0,10,0,0">
                            <Button Text="Ver etiqueta / QR" Style="{StaticResource FlatButton}" Clicked="OnVerEtiquetaClicked"/>
                            <Button Grid.Column="1" Text="Reportar incidencia" Style="{StaticResource FlatButton}" Clicked="OnReportarIncidenciaClicked"/>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- Timeline -->
                <Frame Style="{StaticResource Card}">
                    <VerticalStackLayout>
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Seguimiento" Style="{StaticResource H2}"/>
                            <Button Grid.Column="1" Text="Marcar entregado" Style="{StaticResource FlatButton}" Clicked="OnMarcarEntregadoClicked"/>
                        </Grid>

                        <CollectionView ItemsSource="{Binding Eventos}" Margin="0,6,0,0">
                            <CollectionView.EmptyView>
                                <Label Text="Sin eventos de seguimiento." TextColor="{StaticResource TextLight}" />
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="Auto,*" Padding="0,8" ColumnSpacing="12">
                                        <Frame WidthRequest="10" HeightRequest="10" CornerRadius="5" HasShadow="False"
                                               BackgroundColor="{StaticResource Primary}" VerticalOptions="Start"/>
                                        <VerticalStackLayout Grid.Column="1" Spacing="2">
                                            <Label Text="{Binding Titulo}" FontAttributes="Bold"/>
                                            <Label Text="{Binding Detalle}" TextColor="{StaticResource TextLight}"/>
                                            <Label Text="{Binding Fecha, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                                                   FontSize="12" TextColor="{StaticResource TextLight}"/>
                                        </VerticalStackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>

                <!-- Acciones inferiores -->
                <Grid ColumnDefinitions="*,Auto" Margin="0,4,0,16">
                    <Button Text="Compartir tracking" Style="{StaticResource PrimaryButton}" Clicked="OnCompartirClicked"/>
                    <Button Grid.Column="1" Text="Más opciones" Style="{StaticResource FlatButton}" Clicked="OnMasOpcionesClicked"/>
                </Grid>

            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>
