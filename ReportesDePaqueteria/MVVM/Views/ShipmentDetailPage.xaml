<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="ReportesDePaqueteria.MVVM.Views.ShipmentDetailPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:conv="clr-namespace:ReportesDePaqueteria.Converters"
             Title="Detalle de envío"
             BackgroundColor="#F5F6F8"
             Shell.NavBarIsVisible="False">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Paleta -->
            <Color x:Key="Primary">#FF8302</Color>
            <Color x:Key="PrimarySoft">#FFF0E0</Color>
            <Color x:Key="TextDark">#111827</Color>
            <Color x:Key="TextLight">#6B7280</Color>
            <Color x:Key="CardBg">#FFFFFF</Color>
            <Color x:Key="ChipBg">#E5E7EB</Color>
            <Color x:Key="Success">#10B981</Color>

            <!-- Tipos -->
            <Style TargetType="Label" x:Key="H1">
                <Setter Property="FontSize" Value="22"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="TextColor" Value="White"/>
            </Style>
            <Style TargetType="Label" x:Key="H2">
                <Setter Property="FontSize" Value="18"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="TextColor" Value="{StaticResource TextDark}"/>
                <Setter Property="Margin" Value="0,10,0,6"/>
            </Style>
            <Style TargetType="Label" x:Key="MetaWhite">
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="TextColor" Value="#FFFFFFCC"/>
            </Style>

            <!-- Card / Chip / Botones -->
            <Style TargetType="Frame" x:Key="Card">
                <Setter Property="Padding" Value="16"/>
                <Setter Property="Margin" Value="0,10"/>
                <Setter Property="BackgroundColor" Value="{StaticResource CardBg}"/>
                <Setter Property="CornerRadius" Value="16"/>
                <Setter Property="HasShadow" Value="True"/>
            </Style>
            <Style TargetType="Frame" x:Key="Chip">
                <Setter Property="Padding" Value="8,4"/>
                <Setter Property="BackgroundColor" Value="{StaticResource ChipBg}"/>
                <Setter Property="CornerRadius" Value="16"/>
                <Setter Property="HasShadow" Value="False"/>
            </Style>
            <Style TargetType="Button" x:Key="PrimaryButton">
                <Setter Property="BackgroundColor" Value="{StaticResource Primary}"/>
                <Setter Property="TextColor" Value="White"/>
                <Setter Property="CornerRadius" Value="12"/>
                <Setter Property="Padding" Value="14,12"/>
            </Style>
            <Style TargetType="Button" x:Key="SuccessButton">
                <Setter Property="BackgroundColor" Value="{StaticResource Success}"/>
                <Setter Property="TextColor" Value="White"/>
                <Setter Property="CornerRadius" Value="12"/>
                <Setter Property="Padding" Value="14,12"/>
            </Style>
            <Style TargetType="Button" x:Key="FlatButton">
                <Setter Property="BackgroundColor" Value="Transparent"/>
                <Setter Property="TextColor" Value="{StaticResource Primary}"/>
                <Setter Property="Padding" Value="10,8"/>
            </Style>

            <!-- Converter para visibilidad -->
            <conv:BoolFromStringConverter x:Key="BoolFromStringConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">

        <!-- Header -->
        <Grid Grid.Row="0" Padding="20,20,20,14">
            <Grid.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                    <GradientStop Color="#FF9F3A" Offset="0"/>
                    <GradientStop Color="#FF8302" Offset="1"/>
                </LinearGradientBrush>
            </Grid.Background>

            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="Auto,*" ColumnSpacing="10">

                <!-- Botón atrás -->
                <Button Text="←"
                        Command="{Binding BackCommand}"
                        BackgroundColor="Transparent"
                        TextColor="White"
                        FontSize="20"
                        Padding="0" />

                <!-- Tracking -->
                <Label Grid.Column="1"
                       Text="{Binding Code}"
                       Style="{StaticResource H1}"
                       VerticalOptions="Center" />

                <!-- Chips de estado -->
                <HorizontalStackLayout Grid.Row="1" Grid.ColumnSpan="2" Spacing="8">
                    <Frame Style="{StaticResource Chip}">
                        <Label Text="{Binding EstadoText}" FontSize="12">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label" Binding="{Binding EstadoText}" Value="Entregado">
                                    <Setter Property="TextColor" Value="{StaticResource Success}"/>
                                </DataTrigger>
                                <DataTrigger TargetType="Label" Binding="{Binding EstadoText}" Value="En tránsito">
                                    <Setter Property="TextColor" Value="#F59E0B"/>
                                </DataTrigger>
                                <DataTrigger TargetType="Label" Binding="{Binding EstadoText}" Value="Enviado">
                                    <Setter Property="TextColor" Value="#DC2626"/>
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>
                        <Frame.Triggers>
                            <DataTrigger TargetType="Frame" Binding="{Binding EstadoText}" Value="Entregado">
                                <Setter Property="BackgroundColor" Value="#DCFCE7"/>
                            </DataTrigger>
                            <DataTrigger TargetType="Frame" Binding="{Binding EstadoText}" Value="En tránsito">
                                <Setter Property="BackgroundColor" Value="#FEF3C7"/>
                            </DataTrigger>
                            <DataTrigger TargetType="Frame" Binding="{Binding EstadoText}" Value="Enviado">
                                <Setter Property="BackgroundColor" Value="#FEE2E2"/>
                            </DataTrigger>
                        </Frame.Triggers>
                    </Frame>
                </HorizontalStackLayout>

                <!-- Fechas (reales) -->
                <Grid Grid.Row="1" Grid.Column="1" HorizontalOptions="End">
                    <Label Text="{Binding Shipment.CreatedDate, StringFormat='Creado: {0:dd/MM/yyyy}'}"
                           Style="{StaticResource MetaWhite}" HorizontalTextAlignment="End"/>
                </Grid>
            </Grid>
        </Grid>

        <!-- Contenido -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="16" Spacing="6">

                <Frame Style="{StaticResource Card}">
                    <VerticalStackLayout>
                        <Label Text="Remitente y Destinatario" Style="{StaticResource H2}"/>
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                            <VerticalStackLayout Spacing="2">
                                <Label Text="Remitente" FontAttributes="Bold"/>
                                <Label Text="{Binding Shipment.Sender.Name}" />
                                <Label Text="{Binding Shipment.Sender.Email}" TextColor="{StaticResource TextLight}" FontSize="12"/>
                            </VerticalStackLayout>
                            <VerticalStackLayout Grid.Column="1" Spacing="2">
                                <Label Text="Destinatario" FontAttributes="Bold"/>
                                <Label Text="{Binding Shipment.ReceiverName}" />
                            </VerticalStackLayout>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <Frame Style="{StaticResource Card}">
                    <VerticalStackLayout Spacing="6">
                        <Label Text="Detalle del envío" Style="{StaticResource H2}"/>
                        <Label Text="{Binding Shipment.Description}" TextColor="{StaticResource TextDark}" />
                    </VerticalStackLayout>
                </Frame>

                <Frame Style="{StaticResource Card}">
                    <VerticalStackLayout>
                        <Label Text="Ruta" Style="{StaticResource H2}"/>
                        <Grid ColumnDefinitions="*,Auto,*" ColumnSpacing="10">
                            <VerticalStackLayout Spacing="2"
                                                 IsVisible="{Binding Shipment.Origin, Converter={StaticResource BoolFromStringConverter}}">
                                <Label Text="Origen" FontAttributes="Bold"/>
                                <Label Text="{Binding Shipment.Origin}" TextColor="{StaticResource TextLight}"/>
                            </VerticalStackLayout>

                            <Label Grid.Column="1" Text="→" FontSize="20" VerticalOptions="Center" TextColor="{StaticResource TextLight}"/>

                            <VerticalStackLayout Grid.Column="2" Spacing="2"
                                                 IsVisible="{Binding Shipment.Destination, Converter={StaticResource BoolFromStringConverter}}">
                                <Label Text="Destino" FontAttributes="Bold"/>
                                <Label Text="{Binding Shipment.Destination}" TextColor="{StaticResource TextLight}"/>
                            </VerticalStackLayout>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- Información del trabajador asignado -->
                <Frame Style="{StaticResource Card}" IsVisible="{Binding Shipment.Worker, Converter={StaticResource IsNotNullConverter}}">
                    <VerticalStackLayout Spacing="6">
                        <Label Text="Trabajador asignado" Style="{StaticResource H2}"/>
                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                            <Frame WidthRequest="40" HeightRequest="40" CornerRadius="20" BackgroundColor="{StaticResource PrimarySoft}" HasShadow="False">
                                <Label Text="👷" FontSize="20" HorizontalOptions="Center" VerticalOptions="Center"/>
                            </Frame>
                            <VerticalStackLayout Grid.Column="1" Spacing="2">
                                <Label Text="{Binding Shipment.Worker.Name}" FontAttributes="Bold"/>
                                <Label Text="{Binding Shipment.Worker.Email}" TextColor="{StaticResource TextLight}" FontSize="12"/>
                            </VerticalStackLayout>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- Timeline -->
                <Frame Style="{StaticResource Card}">
                    <VerticalStackLayout>
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Seguimiento" Style="{StaticResource H2}"/>
                            <Button Grid.Column="1" 
                                    Text="✅ Marcar entregado"
                                    Style="{StaticResource SuccessButton}"
                                    Command="{Binding MarkDeliveredCommand}"
                                    IsVisible="{Binding CanMarkDelivered}"/>
                        </Grid>

                        <CollectionView ItemsSource="{Binding Eventos}" Margin="0,6,0,0">
                            <CollectionView.EmptyView>
                                <Label Text="Sin eventos de seguimiento." TextColor="{StaticResource TextLight}" />
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="Auto,*" Padding="0,8" ColumnSpacing="12">
                                        <Frame WidthRequest="10" HeightRequest="10" CornerRadius="5" HasShadow="False"
                                               BackgroundColor="{StaticResource Primary}" VerticalOptions="Start"/>
                                        <VerticalStackLayout Grid.Column="1" Spacing="2">
                                            <Label Text="{Binding Titulo}" FontAttributes="Bold"/>
                                            <Label Text="{Binding Detalle}" TextColor="{StaticResource TextLight}"/>
                                            <Label Text="{Binding Fecha, StringFormat='{0:dd/MM/yyyy HH:mm}'}"
                                                   FontSize="12" TextColor="{StaticResource TextLight}"/>
                                        </VerticalStackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>

                <!-- Acciones inferiores-->
                <Grid ColumnDefinitions="*,Auto" Margin="0,4,0,16">
                    <Button Text="📝 Reportar incidencia" 
                            Style="{StaticResource FlatButton}" 
                            Command="{Binding ReportIncidentCommand}"/>
                    <Button Grid.Column="1" 
                            Text="⚙️ Más opciones" 
                            Style="{StaticResource FlatButton}" 
                            Command="{Binding MoreOptionsCommand}"
                            IsVisible="{Binding CanAccessAdminOptions}"/>
                </Grid>

                <!-- Indicador de carga -->
                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                   IsVisible="{Binding IsBusy}"
                                   Color="{StaticResource Primary}"
                                   Margin="0,20"/>

            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>